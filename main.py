from flask import Flask, request, jsonify
import requests
import os
from dotenv import load_dotenv
import logging
import sys

# ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ù„Ø§Ú¯
logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s - %(levelname)s - %(message)s',
    stream=sys.stdout
)
logger = logging.getLogger(__name__)

load_dotenv()
app = Flask(__name__)

TELEGRAM_TOKEN = os.getenv('TELEGRAM_TOKEN')

def get_ai_response(message):
    """Ù¾Ø§Ø³Ø®â€ŒÙ‡Ø§ÛŒ Ù‡ÙˆØ´Ù…Ù†Ø¯ Ø³Ø§Ø¯Ù‡ Ø¨Ø¯ÙˆÙ† API Ø®Ø§Ø±Ø¬ÛŒ"""
    message_lower = message.lower().strip()
    
    # Ù¾Ø§Ø³Ø®â€ŒÙ‡Ø§ÛŒ Ø§Ø² Ù¾ÛŒØ´ ØªØ¹Ø±ÛŒÙ Ø´Ø¯Ù‡
    responses = {
        'Ø³Ù„Ø§Ù…': 'Ø³Ù„Ø§Ù…! Ø®ÙˆØ´ Ø§ÙˆÙ…Ø¯ÛŒ! ðŸ¤–\nÙ…Ù† ÛŒÙ‡ Ø±Ø¨Ø§Øª Ø³Ø§Ø¯Ù‡â€ŒØ§Ù… Ú©Ù‡ Ù…ÛŒâ€ŒØªÙˆÙ†Ù‡ Ø¨Ù‡Øª Ú©Ù…Ú© Ú©Ù†Ù‡.',
        
        'Ú†Ø·ÙˆØ±ÛŒ': 'Ø®ÙˆØ¨Ù… Ù…Ù…Ù†ÙˆÙ†! ðŸ˜Š\nÚ†Ø·ÙˆØ± Ù…ÛŒâ€ŒØªÙˆÙ†Ù… Ú©Ù…Ú© Ú©Ù†Ù…ØŸ',
        
        'Ú©Ù…Ú©': '''ðŸ“‹ Ø±Ø§Ù‡Ù†Ù…Ø§ÛŒ Ø±Ø¨Ø§Øª:

ðŸ¤– **Ø¯Ø±Ø¨Ø§Ø±Ù‡ Ù…Ù†:**
â€¢ ÛŒÙ‡ Ø±Ø¨Ø§Øª Ø³Ø§Ø¯Ù‡ Ùˆ Ù…ÙÛŒØ¯
â€¢ Ø¢Ù…Ø§Ø¯Ù‡ Ù¾Ø§Ø³Ø® Ø¨Ù‡ Ø³ÙˆØ§Ù„Ø§ØªØª
â€¢ Ø¯Ø± Ø­Ø§Ù„ ØªÙˆØ³Ø¹Ù‡ Ù‚Ø§Ø¨Ù„ÛŒØªâ€ŒÙ‡Ø§ÛŒ Ø¨ÛŒØ´ØªØ±

ðŸ’¡ **Ú©Ø§Ø±Ù‡Ø§ÛŒÛŒ Ú©Ù‡ Ù…ÛŒâ€ŒØªÙˆÙ†Ù… Ø§Ù†Ø¬Ø§Ù… Ø¨Ø¯Ù…:**
â€¢ Ù¾Ø§Ø³Ø® Ø¨Ù‡ Ø³ÙˆØ§Ù„Ø§Øª Ù…ØªØ¯Ø§ÙˆÙ„
â€¢ Ø§Ø±Ø§Ø¦Ù‡ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ù…ÙÛŒØ¯
â€¢ Ø±Ø§Ù‡Ù†Ù…Ø§ÛŒÛŒ Ø¯Ø± Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² Ø±Ø¨Ø§Øª

ðŸ”œ **Ø¨Ù‡ Ø²ÙˆØ¯ÛŒ:**
â€¢ ØªØ­Ù„ÛŒÙ„ ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ø§Ú©Ø³Ù„
â€¢ Ø§ØªØµØ§Ù„ Ø¨Ù‡ Ù‡ÙˆØ´ Ù…ØµÙ†ÙˆØ¹ÛŒ
â€¢ Ù‚Ø§Ø¨Ù„ÛŒØªâ€ŒÙ‡Ø§ÛŒ Ù¾ÛŒØ´Ø±ÙØªÙ‡â€ŒØªØ±

Ø³ÙˆØ§Ù„Øª Ø±Ùˆ Ø¨Ù¾Ø±Ø³!''',
        
        'Ø®Ø¯Ø§Ø­Ø§ÙØ¸': 'Ø®Ø¯Ø§Ø­Ø§ÙØ¸! ðŸ™‹â€â™‚ï¸\nØ§Ù…ÛŒØ¯ÙˆØ§Ø±Ù… Ù…ÙÛŒØ¯ Ø¨ÙˆØ¯Ù‡ Ø¨Ø§Ø´Ù….',
        
        'Ø§Ø³Ù…Øª Ú†ÛŒÙ‡': 'Ù…Ù† ÛŒÙ‡ Ø±Ø¨Ø§Øª ØªÙ„Ú¯Ø±Ø§Ù…ÛŒ Ù‡Ø³ØªÙ… Ú©Ù‡ Ø¯ÙˆØ³Øª Ø¯Ø§Ø±Ù… Ø¨Ù‡ Ú©Ø§Ø±Ø¨Ø±Ø§Ù† Ú©Ù…Ú© Ú©Ù†Ù…! ðŸ¤–',
        
        'Ú†ÛŒÚ©Ø§Ø± Ù…ÛŒØªÙˆÙ†ÛŒ Ø¨Ú©Ù†ÛŒ': 'Ù…ÛŒØªÙˆÙ†Ù…:\nâ€¢ Ø±Ø§Ù‡Ù†Ù…Ø§ÛŒÛŒ Ú©Ù†Ù…\nâ€¢ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ù…ÙÛŒØ¯ Ø¨Ø¯Ù…\nâ€¢ Ø¨Ù‡ Ø³ÙˆØ§Ù„Ø§ØªØª Ù¾Ø§Ø³Ø® Ø¨Ø¯Ù…\nâ€¢ Ùˆ Ø¨Ù‡ Ø²ÙˆØ¯ÛŒ Ø®ÛŒÙ„ÛŒ Ú†ÛŒØ²Ø§ÛŒ Ø¯ÛŒÚ¯Ù‡! ðŸš€'
    }
    
    # Ø¬Ø³ØªØ¬ÙˆÛŒ Ù¾Ø§Ø³Ø® Ø¯Ø± Ø¯ÛŒÚ©Ø´Ù†Ø±ÛŒ
    for key, response in responses.items():
        if key in message_lower:
            return response
    
    # Ù¾Ø§Ø³Ø® Ù¾ÛŒØ´â€ŒÙØ±Ø¶ Ø¨Ø±Ø§ÛŒ Ø³ÙˆØ§Ù„Ø§Øª Ø¯ÛŒÚ¯Ø±
    return f'''ðŸ¤” Ø³ÙˆØ§Ù„ Ø¬Ø§Ù„Ø¨ÛŒ Ù¾Ø±Ø³ÛŒØ¯ÛŒ: "{message}"

Ø¯Ø± Ø­Ø§Ù„ Ø­Ø§Ø¶Ø± Ù…Ù† ÛŒÚ© Ø±Ø¨Ø§Øª Ù¾Ø§ÛŒÙ‡â€ŒØ§Ù… Ùˆ Ù‚Ø§Ø¨Ù„ÛŒØª Ù¾Ø§Ø³Ø® Ø¨Ù‡ Ø³ÙˆØ§Ù„Ø§Øª Ù¾ÛŒÚ†ÛŒØ¯Ù‡ Ø±Ùˆ Ù†Ø¯Ø§Ø±Ù….

Ø§Ù…Ø§ Ù…ÛŒâ€ŒØªÙˆÙ†ÛŒ Ø§Ø²Ù… Ø¨Ù¾Ø±Ø³ÛŒ:
â€¢ "Ú©Ù…Ú©" - Ø±Ø§Ù‡Ù†Ù…Ø§ÛŒ Ú©Ø§Ù…Ù„
â€¢ "Ú†ÛŒÚ©Ø§Ø± Ù…ÛŒØªÙˆÙ†ÛŒ Ø¨Ú©Ù†ÛŒ" - Ù‚Ø§Ø¨Ù„ÛŒØªâ€ŒÙ‡Ø§ÛŒ Ù…Ù†

Ø¨Ù‡ Ø²ÙˆØ¯ÛŒ Ù‡ÙˆØ´ Ù…ØµÙ†ÙˆØ¹ÛŒ Ù‚Ø¯Ø±ØªÙ…Ù†Ø¯ÛŒ Ø¨Ù‡ Ø±Ø¨Ø§Øª Ø§Ø¶Ø§ÙÙ‡ Ù…ÛŒØ´Ù‡! ðŸ’ª'''

@app.route('/', methods=['POST'])
def webhook():
    """ÙˆØ¨â€ŒÙ‡ÙˆÚ© Ø§ØµÙ„ÛŒ ØªÙ„Ú¯Ø±Ø§Ù…"""
    try:
        data = request.get_json()
        logger.info(f"ðŸ“© Ø¯Ø±ÛŒØ§ÙØª Ø§Ø² ØªÙ„Ú¯Ø±Ø§Ù…: {data}")
        
        message = data.get('message') or data.get('edited_message')
        if not message:
            return 'no message', 400

        chat_id = message['chat']['id']
        text = message.get('text', '')
        
        if text == '/start':
            reply = '''ðŸ¤– Ø³Ù„Ø§Ù…! Ø¨Ù‡ Ø±Ø¨Ø§Øª Ù…Ù† Ø®ÙˆØ´ Ø§ÙˆÙ…Ø¯ÛŒ!

Ù…Ù† Ø¯Ø± Ø­Ø§Ù„ Ø­Ø§Ø¶Ø± ÛŒÚ© Ø±Ø¨Ø§Øª Ù¾Ø§ÛŒÙ‡â€ŒØ§Ù… Ú©Ù‡ Ù…ÛŒâ€ŒØªÙˆÙ†Ù‡:
â€¢ Ø¨Ù‡ Ø³ÙˆØ§Ù„Ø§Øª Ø³Ø§Ø¯Ù‡ Ù¾Ø§Ø³Ø® Ø¨Ø¯Ù‡
â€¢ Ø±Ø§Ù‡Ù†Ù…Ø§ÛŒÛŒ Ú©Ù†Ù‡
â€¢ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ù…ÙÛŒØ¯ Ø§Ø±Ø§Ø¦Ù‡ Ø¨Ø¯Ù‡

ðŸ’¡ **Ø¯Ø³ØªÙˆØ±Ø§Øª Ø³Ø±ÛŒØ¹:**
"Ú©Ù…Ú©" - Ø±Ø§Ù‡Ù†Ù…Ø§ÛŒ Ú©Ø§Ù…Ù„
"Ú†ÛŒÚ©Ø§Ø± Ù…ÛŒØªÙˆÙ†ÛŒ Ø¨Ú©Ù†ÛŒ" - Ù‚Ø§Ø¨Ù„ÛŒØªâ€ŒÙ‡Ø§

Ø¨Ù‡ Ø²ÙˆØ¯ÛŒ Ù‚Ø§Ø¨Ù„ÛŒØªâ€ŒÙ‡Ø§ÛŒ Ù¾ÛŒØ´Ø±ÙØªÙ‡â€ŒØªØ±ÛŒ Ø§Ø¶Ø§ÙÙ‡ Ù…ÛŒØ´Ù‡! ðŸš€'''
        else:
            reply = get_ai_response(text)
        
        # Ø§Ø±Ø³Ø§Ù„ Ù¾Ø§Ø³Ø® Ø¨Ù‡ Ú©Ø§Ø±Ø¨Ø±
        requests.post(
            f'https://api.telegram.org/bot{TELEGRAM_TOKEN}/sendMessage',
            data={'chat_id': chat_id, 'text': reply}
        )
        
        logger.info(f"âœ… Ù¾Ø§Ø³Ø® Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯: {reply[:50]}...")
        return 'ok'
        
    except Exception as e:
        logger.error(f"ðŸ”¥ Ø®Ø·Ø§ Ø¯Ø± ÙˆØ¨â€ŒÙ‡ÙˆÚ©: {str(e)}")
        return 'error', 500

@app.route('/', methods=['GET'])
def home():
    return 'ðŸ¤– Ø±Ø¨Ø§Øª Ù¾Ø§ÛŒÙ‡ ÙØ¹Ø§Ù„ Ø§Ø³Øª!'

@app.route('/test', methods=['GET'])
def test():
    """ØªØ³Øª Ø³Ù„Ø§Ù…Øª"""
    return jsonify({
        "status": "active", 
        "telegram_token": "SET" if TELEGRAM_TOKEN else "NOT SET",
        "message": "Ø±Ø¨Ø§Øª Ù¾Ø§ÛŒÙ‡ ÙØ¹Ø§Ù„ Ø§Ø³Øª"
    })

@app.route('/test-response', methods=['GET'])
def test_response():
    """ØªØ³Øª Ø³ÛŒØ³ØªÙ… Ù¾Ø§Ø³Ø®â€ŒØ¯Ù‡ÛŒ"""
    test_messages = [
        "Ø³Ù„Ø§Ù…",
        "Ú©Ù…Ú©", 
        "Ú†ÛŒÚ©Ø§Ø± Ù…ÛŒØªÙˆÙ†ÛŒ Ø¨Ú©Ù†ÛŒ",
        "Ø³ÙˆØ§Ù„ ØªØ³Øª"
    ]
    
    results = []
    for msg in test_messages:
        response = get_ai_response(msg)
        results.append({
            "question": msg,
            "response": response[:100] + "..." if len(response) > 100 else response
        })
    
    return jsonify({"tests": results})

if __name__ == '__main__':
    port = int(os.environ.get('PORT', 10000))
    app.run(host='0.0.0.0', port=port)
